#!/bin/bash
######################################################################
# process_replaygain
# 
# Usage:
#     process_replaygain DIRECTORY OPTS
######################################################################
Date=$(eval date +%Y%m%d)
WorkingDir=""
MusicRootDir=$HOME/Music
ScriptsDir=$HOME/code/scripts
LogFile=$ScriptsDir/logs/mp3gain-$Date.tsv
ErrLogFile=$ScriptsDir/logs/mp3gain-$Date.err.log
Options=" -T -k -o"
while [[ $# > 0 ]]
do
  arg="$1"
  if [[ -d $arg ]]
  then
    WorkingDir="$(readlink -f $arg)"
  else
    Options="$Options $arg"
  fi
  shift
done
if ! [[ $Options =~ .*(-a|-r).* ]]
then
  echo "Missing required option. Please specify -a or -r."
  exit 1
elif [[ $Options =~ .*-a.* ]] && [[ $Options =~ .*-r.* ]]
then
  echo "Invalid options. Please specify -a or -r (not both)."
  exit 1
fi
if [[ $WorkingDir == "" ]]
then
  echo "Please specify a directory for processing."
  exit 1
fi

process_dir() {
  if [[ $1 != $MusicRootDir ]]
  then
    echo "Processing replaygain for mp3 files in $1"
    find $1 -name *.mp3 -exec mp3gain $Options {} \+ >> $LogFile 2>> $ErrLogFile
  fi
}

if [[ $Options =~ .*-a.* ]]
then
  echo "Using album mode for each subdirectory of $WorkingDir"
  SAVEIFS=$IFS
  IFS=$'\n'
  dirs=($(find $WorkingDir -type d))
  for (( i=0; i<${#dirs[@]}; i++ ))
  do
    process_dir ${dirs[$i]}
  done
  IFS=$SAVEIFS
else
  echo "Using track mode for all tracks in $WorkingDir"
  process_dir $WorkingDir
fi
